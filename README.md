> 做JAVA开发队友们常常在聊的一个话题就是NIO，听的最多的关键词就是多路复用，Netty，高性能，高并发等等，然后摸不着头脑的就去百度，看几篇帖子似懂非懂，最终这就是死循环，永远没有具体搞明白NIO，BIO，AIO的来龙去脉。面临这样的问题，最近自己理解Java IO相关的知识，顺便整理了下来，这些知识点到处都能够获取到，文中大部分篇幅截取网络文章或者书籍，篇尾有相应原文出处。

# 计算机组成原理-I/O
> IO即输入输出，提到输入输出首先我们需要巩固的知识点就是计算机组成原理（这块知识必须要有所掌握）。

 要理解I/O，首先我们需要先从最基础原理说起。这里推荐北京大学一个网络课程（操作系统原理）[I/O系统](https://www.coursera.org/learn/os-pku/home/week/11)，主要讲内容：设备管理的目标和任务；I/O设备分类；I/O设备组成；I/O端口地址；I/O控制方式；I/O软件层次；设备分配算法；设备驱动程序；缓冲技术；I/O性能问题。
## I/O 系统概述
### I/O 系统的发展
 计算机主机与外界交换信息时所涉及到的硬件和软件的总称，称为 I/O 系统。I/O 系统的发展大致分为 4 个阶段：

#### 早期阶段

早期的I/O设备种类较少，I/O设备与主存交换信息都必须通过CPU.

![](https://github.com/moxingwang/collection/blob/master/resources/image/io/io1.png?raw=true)

这种交换方式延续了相当长的时间。当时的I/O设备具有以下几个特点：

* 每个I/O设备都必须配有一套独立的逻辑电路与CPU相连，用来实现I/O设备与主机之间的信息交换，因此线路十分散乱、庞杂。
* 输入输出过程是穿插在CPU执行程序过程之中进行的，当I/O设备与主机交换信息时，CPU不得不停止各种运算，因此，I/O设备与CPU是按串行方式工作的，极浪费时间。
* 每个I/O设备的逻辑控制电路与CPU的控制器紧密构成一个不可分割的整体，它们彼此依赖，相互牵连，因此，欲增添、撤减或更换I/O设备是非常困难的。

#### 接口模块和DMA阶段
这个阶段I/O设备通过接口模块与主机连接，计算机系统采用了总线结构。

![](https://github.com/moxingwang/collection/blob/master/resources/image/io/io2.png?raw=true)

通常，在接口中都设有数据通路和控制通路。数据经过接口既起到缓冲作用，又可完成串-并变换。控制通路用以传送CPU向I/O设备发出的各种控制命令，或使CPU接受来自I/O设备的反馈信号。许多接口还能满足中断请求处理的要求，使I/O设备与CPU可按并行方式工作，大大地提高了CPU的工作效率。采用接口技术还可以使多台I/O设备分时占用总线，使多台I/O设备互相之间也可实现并行工作方式，有利于整机工作效率的提高。

虽然这个阶段实现了CPU与I/O设备并行工作，但是在主机与I/O设备交换信息时，CPU要中断现行程序，即CPU与I/O设备还不能做到绝对的并行工作。为了进一步提高CPU的工作效率，后来出现了DMA（Direct Memory Access，直接存储器存取）技术，其特点是I/O设备与主存之间有一条直接数据通路，I/O设备可以与主存直接交换信息，使CPU在I/O设备与主存交换信息时能继续完成自身的工作，故资源利用率得到了进一步提高。

#### 具有通道结构的阶段
在小型和微型计算机中，采用DMA方式可实现高速I/O设备与主机之间成组数据的交换，但在大中型计算机中，I/O设备配置繁多，数据传送频繁，若仍采用DMA方式会出现一系列问题。① 如果每台I/O设备都配置专用的DMA接口，不仅增加了硬件成本，而且为了解决众多DMA接口同时访问主存的冲突问题，会使控制变得十分复杂。②CPU需要对众多的DMA接口进行管理，同样会占用CPU的工作时间，而且因频繁地进入周期挪用阶段，也会直接影响CPU的整体工作效率。因此在大中型计算机系统中，采用I/O通道的方式来进行数据交换。如5.3图所示为具有通道结构的计算机系统。

![](https://github.com/moxingwang/collection/blob/master/resources/image/io/io3.png?raw=true)

通道是用来负责管理I/O设备以及实现主存与I/O设备之间交换信息的部件，可以视为一种具有特殊功能的处理器。通道有专用的通道指令，能独立地执行用通道指令所编写的输入输出程序，但不是一个完全独立的处理器。它依据CPU的I/O指令进行启动、停止或改变工作状态，是从属于CPU的一个专用处理器。依赖通道管理的I/O设备在与主机交换信息时，CPU不直接参与管理，故提高了CPU的资源利用率。

#### 具有I/O处理机的阶段

输入输出系统发展到第四阶段，出现了I/O处理机。I/O处理机又称为外围处理机（Peripheral Processor），它基本独立于主机工作，既可完成I/O通道要完成的I/O控制，又可完成码制变换、格式处理、数据块检错、纠错等操作。具有I/O处理机的输入输出系统与CPU工作的并行性更高，这说明I/O系统对主机来说具有更大的独立性。

### 输入输出系统的组成
输入输出系统由I/O软件和I/O硬件两部分组成。

#### I/O软件
I/O 软件的主要任务是，将用户编制的程序（或数据）输入主机内；将运算结果输送给用户；实现输入输出系统与主机的协调等。通常采用 I/O 指令和通道指令实现 CPU 与I/O设备的信息交换。

* I/O 指令
当采用接口模块方式时，应用机器指令系统中的 I/O 指令及系统中的管理程序可使 I/O 设备与主机协调工作。I/O 指令反映 CPU 与 I/O 设备交换信息的各种特点，是 CPU 指令系统的一部分。
* 通道指令
当采用通道方式时，应用通道程序实现 I/O 设备与主机的信息交换。通道指令是对具有通道的 I/O 系统专门设置的指令，用来执行 I/O 操作，如读、写磁盘等。

#### I/O硬件

![](https://github.com/moxingwang/collection/blob/master/resources/image/io/io5.png?raw=true)

输入输出系统的硬件组成是多种多样的，在带有接口的I/O系统中，一般包括接口模块及I/O设备两大部分。图5.2中的接口电路实际上包含许多数据传送通路和有关数据，还包含控制信号通路及其相应的逻辑电路。图5-5是具有通道的I/O系统的示意图。

一个通道可以和一个以上的设备控制器相连，一个设备控制器又可以控制若干台同一类型的设备。例如，IBM360系统的一个通道可以连接8个设备控制器，一个设备控制器又与8台设备相连，因此，一个通道可以管理64台设备。

![](https://github.com/moxingwang/collection/blob/master/resources/image/io/io4.png?raw=true)


### I/O控制方式
随着计算机技术的发展，I/O控制方式也在发展，经历了程序I/O控制，中断控制，DMA控制和通道控制这四种方式。

#### 程序控制

最简单的I/O控制方式是处理机对I/O设备直接进行控制，采取程序I/O（Programmed I/O）方式或称为忙一等待方式。CPU首先向设备控制器的控制寄存器发出一条I/O指令启动I/O设备进行数据传输，硬件同时把状态寄存器中的忙/闲标志busy置为1，表示该I/O设备尚未输入完一个字(符)。接着CPU应重复读取状态寄存器忙/闲标志busy进行测试（cpu不能执行其他进程），直至busy=0，表示该I/O设备已将输入数据送入到I/O控制器的数据寄存器中，于是CPU将从数据寄存器中取出数据，送入内存的指定单元，接着，再启动去读下一个数据，并置busy=l。

在程序I/O方式中，由于CPU的速度远远高于I/O设备，导致CPU的绝大部分时间都处于等待I/O设备完成而循环测试之中，造成了CPU的极大浪费。但是它管理简单，在要求不高的场合可以被采用。

#### 中断控制
在现代计算机系统中，对I/O设备的控制，广泛地采用中断驱动（Interrupt-Driven）方式，即当某进程要启动某个I/O设备时，便由CPU向相应的设备控制器的控制寄存器发出一条I/O命令，然后立即返回继续执行原来的任务。设备控制器便按照该命令的要求去控制I/O设备。若I/O设备忙，则由驱动程序将请求插入设备等待队列。此时， CPU与I/O设备处于并行工作状态。例如，在输入时，当设备控制器收到 CPU发来的读命令后，便准备接收从相应输入设备送来的数据。一旦数据进入数据寄存器，控制器便通过中断请求线INT向CPU发送一中断信号，中断子程序由CPU读取状态寄存器忙/闲标志busy进行测试检查输入过程中是否出错，若无错，便从数据寄存器中读出数据，写入指定内存单元。

所以，中断驱动方式在I/O设备输入数据的过程中，无需 CPU干预，可以使CPU与I/O设备并行工作。仅当输完一个数据时，才需 CPU花费极短的时间去进行中断处理。从而大大地提高了整个系统的资源利用率及吞吐量，特别是CPU的利用率。

#### DMA控制
中断驱动I/O方式虽然大大提高了主机的利用率，但是它以字（节）为单位进行数据传送，每完成一个字（节）的传送，控制器便要向CPU请求一次中断（做保存现场信息，恢复现场等工作），仍然占用了CPU的许多时间。这种方式对于高速的块设备的I/O控制显然是不适合。为了进一步减少CPU对I/O的干预，引入了直接存储器访问DMA（Direct Memory Access）控制方式。

DMA方式是一种完全由硬件执行I／O数据交换的工作方式，它需要使用一个专门的DMA控制器（DMAC），内含于设备控制器，DMAC中有控制状态寄存器、传送字节计数器、内存地址寄存器和数据缓冲寄存器。在这种方式中，DMAC采用盗窃总线控制权的方法从CPU接管对总线的控制，成批的数据交换不经过CPU而直接在内存和I／O设备之间进行。

DMA方式下的数据传送过程可分为三个阶段：

* 预处理阶段：当进程要求设备输入数据时，CPU把准备存放输入数据的内存起始地址以及要传送的字节数分别送入DMAC中的内存地址寄存器和传送字节计数器。另外，还把控制状态寄存器中的中断允许位和启动位置成1，从而启动设备，开始进行数据输入。

* 数据传送阶段：发出数据传输要求的进程进入等待状态，进程调度程序调度其他进程占据CPU。DMAC不断地窃取CPU工作周期，执行数据传送的操作：向内存发出地址和控制信号，进行地址修改，对传送字的个数计数，直到所要求的字节全部传送完毕。   

* 后处理阶段：DMAC在传送完所有字节时，通过中断请求线发出中断信号。CPU在接收到中断信号后，转入中断处理程序进行后续处理。中断处理结束后，CPU返回到被中断的进程中，或切换到新的进程上下文环境中，继续执行。

DMA方式起到代理cpu的功能，较之中断驱动方式，又是成百倍地减少了CPU对 I/O控制的干预，进一步提高了CPU与I/O设备的并行操作程度。

#### 通道控制方式
该方式中系统预先要将I/O的过程实现为一段通道程序，置于内存的特定位置，而后启动通道。由通道负责执行通道程序对外设进行I/O控制，CPU转其他程序运行。I/O完成后通道向CPU发中断信号，CPU花很少时间作善后处理。











# 思路
* 一个socket的过程，建立连接-读-写
* 缓存用来缓解速度之间的不匹配差异



# IO
> 所谓IO阻塞或者非阻塞都是指在IO操作（读或者写的时候）调用线程或者进程的阻塞和非阻塞。
## Linux中的五中IO模型
* 阻塞I/O（blocking I/O）
> 调用线程一直等待读或者写函数的返回。
* 非阻塞I/O （nonblocking I/O）
> 调用函数后直接返回，线程定时检测读写是否完成。
* I/O复用(select 和poll) （I/O multiplexing）
> 多路复用是指使用一个线程来检查多个文件描述符（Socket）的就绪状态，比如调用select和poll函数，传入多个文件描述符，如果有一个文件描述符就绪，则返回，否则阻塞直到超时。得到就绪状态后进行真正的操作可以在同一个线程里执行，也可以启动线程执行（比如使用线程池）。
* 信号驱动I/O （signal driven I/O (SIGIO)）
> 信号驱动 IO 的方式是发送 SIGIO 信号来通知某个 fd 是可读或是可写的。 fd 的阻塞等待或是轮询都让系统来进行托管，而不是在用户态处理。
* 异步I/O （asynchronous I/O (the POSIX aio_functions)）
> 调用函数直接返回继续执行，读写结果其它方式通知。


# socket
* socket是什么
> socket是一种操作系统提供的进程间通信机制。在操作系统中，通常会为应用程序提供一组应用程序接口（API），称为套接字接口（英语：socket API）。应用程序可以通过套接字接口，来使用网络套接字，以进行数据交换。在套接字接口中，以IP地址及通信端口组成套接字地址（socket address）。远程的套接字地址，以及本地的套接字地址完成连接后，再加上使用的协议（protocol），这个五元组（five-element tuple），作为套接字对（socket pairs），之后就可以彼此交换数据。例如，在同一台计算机上，TCP协议与UDP协议可以同时使用相同的port而互不干扰。 操作系统根据套接字地址，可以决定应该将数据送达特定的进程或线程。这就像是电话系统中，以电话号码加上分机号码，来决定通话对象一般。[维基百科](https://zh.wikipedia.org/wiki/%E7%B6%B2%E8%B7%AF%E6%8F%92%E5%BA%A7)

* socket是如何工作的

![](https://github.com/moxingwang/collection/blob/master/resources/image/socket_abstract.jpg?raw=true)

> Socket是应用层与TCP/IP协议族通信的中间软件抽象层,它是一组接口.在设计模式中,Socket其实就是一个门面模式,它把复杂的TCP/IP协议族隐藏在Socket接口后面,对用户来说,一组简单的接口就是全部,让Socket去组织数据,以符合指定的协议。[图解socket原理](https://blog.csdn.net/ce123_zhouwei/article/details/8918959)

* 总结
> 简单的说socket是一种操作系统进程通信机制，对网际协议抽象，对因用层提供接口调用。

# 同步，异步，阻塞，非阻塞概念
## 同步和异步
> 同步和异步描述的调用结果。

* 同步
> 所谓同步，就是在发出一个功能调用时，在没有得到结果之前，该调用就不返回。也就是必须一件一件事做,等前一件做完了才能做下一件事。例如普通B/S模式（同步）：提交请求->等待服务器处理->处理完毕返回 这个期间客户端浏览器不能干任何事。

* 异步
> 异步的概念和同步相对。当一个异步过程调用发出后，调用者不能立刻得到结果。实际处理这个调用的部件在完成后，通过状态、通知和回调来通知调用者。例如 ajax请求（异步）: 请求通过事件触发->服务器处理（这是浏览器仍然可以作其他事情）->处理完毕。
 
## 阻塞和非阻塞
> 阻塞和非阻塞的主题是线程。

* 阻塞
> 阻塞调用是指调用结果返回之前，当前线程会被挂起（线程进入非可执行状态，在这个状态下，cpu不会给线程分配时间片，即线程暂停运行）。函数只有在得到结果之后才会返回。有人也许会把阻塞调用和同步调用等同起来，实际上他是不同的。对于同步调用来说，很多时候当前线程还是激活的，只是从逻辑上当前函数没有返回,它还会抢占cpu去执行其他逻辑，也会主动检测io是否准备好。

* 非阻塞
> 非阻塞和阻塞的概念相对应，指在不能立刻得到结果之前，该函数不会阻塞当前线程，而会立刻返回。


# JAVA 网络IO
* bio
> 同步阻塞。
* aio
> 异步非阻塞。
* nio
> 同步非阻塞。

# NIO

# 提高服务器性能的方法
* 榨干CUP、内存、物理硬件
* 使用少的线程饱和的工作，减少等待，干有用功


# 学习资料
* [如何学习Java的NIO？](https://www.zhihu.com/question/29005375)
* [基于NIO的长连接的实现已开放到github](https://blog.csdn.net/yangbutao/article/details/18505831)
* [Java 中 BIO、NIO、AIO 模型的对比](http://patchouli-know.com/2017/03/18/java-bio-nio-aio/)
* [julyerr Blog java AIO]（http://julyerr.club/2018/02/22/aio/）
* [julyerr Blog java NIO](http://julyerr.club/2018/02/20/nio/)
* [BIO与NIO、AIO的区别(这个容易理解)](https://blog.csdn.net/skiof007/article/details/52873421)
* [慕课网 Netty入门之WebSocket初体验](https://www.imooc.com/search/?words=netty)
* [关于BIO和NIO的理解](https://www.cnblogs.com/zedosu/p/6666984.html)
* [TCP/IP、Http、Socket的关系理解](https://blog.csdn.net/qq_35181209/article/details/75212533)
* [图解socket原理](https://blog.csdn.net/ce123_zhouwei/article/details/8918959)
* [简述linux同步与异步、阻塞与非阻塞概念以及五种IO模型](https://www.cnblogs.com/chaser24/p/6112071.html)
* [使用事件驱动模型实现高效稳定的网络服务器程序](https://www.ibm.com/developerworks/cn/linux/l-cn-edntwk/index.html)
* [骏马金龙 五种IO模型分析](http://www.cnblogs.com/f-ck-need-u/p/7624733.html#2-i-o-)
* [计算机组成原理——输入输出系统](https://blog.csdn.net/LiuJiuXiaoShiTou/article/details/72800073)
* [输入输出系统的发展和组成](https://blog.csdn.net/dongyanxia1000/article/details/53785266)
* [设备管理学习之IO控制方式](https://www.cnblogs.com/tracylee/archive/2012/10/25/2738930.html)